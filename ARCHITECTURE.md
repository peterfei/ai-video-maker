# 视频生成工厂 - 系统架构文档

## 概述

视频生成工厂是一个自动化的视频内容生成系统，专注于解说/教程类视频的批量生产。系统采用模块化设计，支持多种内容源、自动配音、智能字幕和批量处理。

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        视频生成工厂                          │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │  内容源管理  │───▶│  音频处理   │───▶│  字幕生成   │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│        │                   │                   │             │
│        │                   │                   │             │
│        ▼                   ▼                   ▼             │
│  ┌──────────────────────────────────────────────────┐       │
│  │              视频合成引擎                         │       │
│  └──────────────────────────────────────────────────┘       │
│                          │                                   │
│                          ▼                                   │
│  ┌──────────────────────────────────────────────────┐       │
│  │              任务队列 & 批处理器                  │       │
│  └──────────────────────────────────────────────────┘       │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块

### 1. 内容源管理 (content_sources/)

**职责**: 管理和处理各种内容来源

#### 组件:

- **TextSource** - 文本脚本处理器
  - 解析多种脚本格式
  - 支持时间标记、场景标记
  - 自动分段和时长估算

- **MaterialSource** - 素材库管理器
  - 图片/视频素材加载
  - 智能标签系统
  - 素材选择和调度

- **AISource** (可选) - AI内容生成
  - 脚本生成
  - 关键词建议
  - 内容优化

**数据流**:
```
文本脚本 ──▶ TextSource ──▶ ScriptSegment[]
素材目录 ──▶ MaterialSource ──▶ Material[]
```

### 2. 音频处理 (audio/)

**职责**: 语音合成和音频混合

#### 组件:

- **TTSEngine** - 语音合成引擎
  - 支持 Edge TTS / pyttsx3
  - 多语音选择
  - 语速/音调调节

- **AudioMixer** - 音频混合器
  - 人声+背景音乐混合
  - 音量控制
  - 淡入淡出效果

**数据流**:
```
文本 ──▶ TTSEngine ──▶ 语音文件
语音 + 音乐 ──▶ AudioMixer ──▶ 最终音频
```

### 3. 字幕系统 (subtitle/)

**职责**: 字幕生成和渲染

#### 组件:

- **SubtitleGenerator** - 字幕生成器
  - 文本分割
  - 时间同步
  - SRT格式支持

- **SubtitleRenderer** - 字幕渲染器
  - 字幕样式设置
  - 位置控制
  - 动画效果

**数据流**:
```
文本 + 时长 ──▶ SubtitleGenerator ──▶ SubtitleSegment[]
字幕数据 ──▶ SubtitleRenderer ──▶ TextClip[]
```

### 4. 视频合成引擎 (video_engine/)

**职责**: 视频片段合成和特效处理

#### 组件:

- **VideoCompositor** - 视频合成器
  - 幻灯片制作
  - 多层合成
  - 画中画效果

- **VideoEffects** - 视频特效
  - 转场效果
  - 滤镜效果
  - 动画效果

**数据流**:
```
素材 + 音频 + 字幕 ──▶ VideoCompositor ──▶ 最终视频
```

### 5. 任务管理 (tasks/)

**职责**: 任务调度和批量处理

#### 组件:

- **TaskQueue** - 任务队列
  - 任务持久化
  - 状态管理
  - 统计功能

- **BatchProcessor** - 批处理器
  - 并行处理
  - 错误重试
  - 进度跟踪

**数据流**:
```
VideoTask[] ──▶ TaskQueue ──▶ BatchProcessor ──▶ 结果统计
```

## 工作流程

### 单个视频生成流程

```
1. 加载脚本
   ├─ 读取文本文件或字符串
   └─ 解析为 ScriptSegment[]

2. 加载素材（可选）
   ├─ 扫描素材目录
   └─ 创建 Material[]

3. 生成语音
   ├─ 文本 → TTS → 语音文件
   └─ 获取音频时长

4. 添加背景音乐
   ├─ 加载音乐文件
   ├─ 循环/裁剪到目标时长
   └─ 混合人声和音乐

5. 生成字幕
   ├─ 根据文本和时长分段
   └─ 创建 SubtitleSegment[]

6. 创建视频
   ├─ 素材 → 幻灯片/背景
   └─ 添加音频

7. 渲染字幕
   ├─ 字幕 → TextClip[]
   └─ 合成到视频

8. 导出视频
   └─ 编码并保存
```

### 批量处理流程

```
1. 扫描脚本目录
   └─ 找到所有 .txt 文件

2. 创建任务队列
   └─ 每个脚本 → VideoTask

3. 并行处理
   ├─ 启动工作线程
   ├─ 分配任务
   └─ 监控进度

4. 错误处理
   ├─ 自动重试
   └─ 记录日志

5. 生成报告
   └─ 统计成功/失败
```

## 配置系统

### 配置层次

```
default_config.yaml (默认配置)
     │
     ├─ paths: 路径设置
     ├─ video: 视频参数
     ├─ tts: TTS设置
     ├─ subtitle: 字幕样式
     ├─ music: 背景音乐
     ├─ content_sources: 内容源
     ├─ templates: 视频模板
     ├─ batch: 批处理
     └─ export: 导出设置
```

### 配置加载机制

- 使用 `ConfigLoader` 类管理配置
- 支持环境变量替换
- 点号访问嵌套配置
- 运行时配置覆盖

## 数据模型

### 核心数据结构

```python
# 脚本片段
ScriptSegment:
  - text: str              # 文本内容
  - duration: float        # 持续时间
  - scene_type: str        # 场景类型
  - metadata: dict         # 元数据

# 素材
Material:
  - path: Path            # 文件路径
  - material_type: str    # 类型(image/video)
  - tags: list[str]       # 标签
  - duration: float       # 时长(视频)

# 字幕片段
SubtitleSegment:
  - text: str             # 字幕文本
  - start_time: float     # 开始时间
  - end_time: float       # 结束时间
  - index: int            # 索引

# 视频任务
VideoTask:
  - task_id: str          # 任务ID
  - script_path: str      # 脚本路径
  - materials_dir: str    # 素材目录
  - output_path: str      # 输出路径
  - status: TaskStatus    # 任务状态
  - result: dict          # 生成结果
```

## 技术栈

### 核心依赖

- **MoviePy** - 视频处理
- **Edge TTS** - 语音合成
- **Pillow** - 图像处理
- **pysrt** - 字幕处理
- **PyYAML** - 配置管理

### 系统要求

- Python 3.8+
- FFmpeg (MoviePy依赖)
- 4GB+ RAM (视频处理)
- 网络连接 (Edge TTS)

## 扩展性

### 易于扩展的模块

1. **内容源**
   - 添加新的素材类型
   - 集成更多AI服务

2. **TTS引擎**
   - 支持更多TTS提供商
   - 本地TTS模型

3. **视频效果**
   - 自定义转场效果
   - 高级动画效果

4. **导出格式**
   - 支持更多视频格式
   - 不同质量预设

### 插件系统（未来）

```python
# 未来可能的插件接口
class VideoPlugin:
    def pre_process(self, task): pass
    def post_process(self, video): pass
```

## 性能优化

### 当前优化

- 并行任务处理
- 资源复用（音频缓存）
- 渐进式渲染

### 潜在优化

- GPU加速（需要相应库）
- 分布式处理
- 素材预加载

## 安全考虑

- 文件路径验证
- 输入清理
- 资源限制
- 错误隔离

## 日志和监控

### 日志级别

- DEBUG: 详细调试信息
- INFO: 常规操作信息
- WARNING: 警告信息
- ERROR: 错误信息

### 日志输出

- 控制台：彩色输出
- 文件：错误日志持久化
- 任务：单独的任务日志

## 测试

### 测试层次

1. **单元测试** - 各模块独立测试
2. **集成测试** - 模块协作测试
3. **系统测试** - 端到端测试

### 测试工具

```bash
# 运行系统测试
python test_system.py
```

## 部署建议

### 开发环境

```bash
python src/main.py --script examples/sample_script.txt
```

### 生产环境

- 使用虚拟环境
- 配置日志级别
- 设置资源限制
- 定期清理临时文件

## 未来路线图

### 近期计划

- [ ] Web界面
- [ ] 更多视频模板
- [ ] 性能优化
- [ ] 单元测试覆盖

### 长期计划

- [ ] 分布式处理
- [ ] 实时预览
- [ ] 视频编辑功能
- [ ] 云端部署

## 贡献指南

欢迎贡献代码！请遵循：

1. 保持代码风格一致
2. 添加必要的注释
3. 编写单元测试
4. 更新文档

## 许可证

MIT License

---

**维护者**: Video Factory Team
**最后更新**: 2024
